<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simulador de Fluxo de Pagamento</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #f2f6fb; margin: 0; padding: 0; }
    .container { max-width: 700px; margin: 40px auto; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); padding: 28px; }
    h2 { text-align: center; color: #003366; margin-bottom: 18px; }
    label.field { display:block; margin-top:12px; font-weight:700; color:#333; }
    input[type="text"], input[type="number"], select { width:100%; padding:10px; margin-top:6px; border:1px solid #ccc; border-radius:6px; font-size:15px }
    .radios-row { margin-top:6px; display:flex; gap:18px; align-items:center }
    .radios-row label { font-weight:400 }
    button { width:100%; margin-top:18px; background:#003366; color:#fff; border:none; padding:12px; border-radius:8px; font-size:17px; cursor:pointer }
    button:hover { background:#00509e }
    .result { margin-top:20px; background:#eef3fa; padding:18px; border-radius:8px; font-size:15px; white-space:pre-wrap }
    .small { font-size:13px; color:#444 }
    hr { border:0; height:1px; background:#e0e7f0; margin:12px 0 }
    .actions { display:flex; gap:10px }
    .whatsapp { background:#25D366 }
  </style>
</head>
<body>
  <div class="container">
    <h2>Simulador de Fluxo de Pagamento</h2>

    <label class="field" for="valor">Valor total do imóvel (R$)</label>
    <input type="text" id="valor" value="730.000,00" />

    <label class="field">Percentual até a entrega (%)</label>
    <div style="display:flex; gap:10px; margin-bottom:8px;" role="radiogroup" aria-label="Percentual até a entrega">
      <label><input type="radio" name="percentualEntrega" value="45"> 45%</label>
      <label><input type="radio" name="percentualEntrega" value="50"> 50%</label>
      <label><input type="radio" name="percentualEntrega" value="55"> 55%</label>
      <label><input type="radio" name="percentualEntrega" value="60" checked> 60%</label>
      <label><input type="radio" name="percentualEntrega" value="65"> 65%</label>
      <label><input type="radio" name="percentualEntrega" value="outro" onchange="togglePercentualCustom()"> Outro</label>
    </div>
    
    <div id="percentualCustomContainer" style="display: none; margin-top: 6px;">
      <input type="number" id="percentualCustom" min="1" max="100" placeholder="Digite o percentual (1-100)" style="width: 200px;" />
    </div>

    <label class="field" for="percentualSinal">Percentual do sinal (%)</label>
    <input type="number" id="percentualSinal" value="10" min="0" max="100" />

    <label class="field" for="parcelasMensais">Número de parcelas mensais</label>
    <input type="number" id="parcelasMensais" value="48" min="0" />

    <label class="field">Parcelas intercaladas</label>
    <div class="radios-row" role="radiogroup" aria-label="Parcelas intercaladas">
      <label><input type="radio" name="parcelasIntercaladas" value="4" checked> Semestrais (4)</label>
      <label><input type="radio" name="parcelasIntercaladas" value="8"> Anuais (8)</label>
      <label style="margin-left:auto"><input type="checkbox" id="usarIntercaladasZero"> Usar 0 (não haverá intercaladas)</label>
    </div>

    <label class="field" for="parcelasSinal">Parcelas do sinal (1, 2, 3 ou 4)</label>
    <select id="parcelasSinal">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3" selected>3</option>
      <option value="4">4</option>
    </select>

    <div class="actions">
      <button id="btnCalcular">Calcular Fluxo</button>
      <button id="btnWhatsapp" class="whatsapp" type="button">Compartilhar no WhatsApp</button>
    </div>

    <div class="result" id="resultado"></div>
  </div>

  <script>
    // form helpers
    function formatarMoeda(valor) {
      valor = String(valor).replace(/\D/g,'');
      valor = (parseInt(valor || '0')/100).toFixed(2);
      valor = valor.replace('.',',');
      valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
      return valor;
    }
    function obterValorNumerico(valor) {
      if (typeof valor !== 'string') return 0;
      return parseFloat(valor.replace(/\./g,'').replace(',','.') || 0);
    }

    // máscara simples para o campo de valor
    const campoValor = document.getElementById('valor');
    campoValor.addEventListener('input', function(e){
      e.target.value = formatarMoeda(e.target.value);
    });

    // função para mostrar/ocultar campo de percentual customizado
    function togglePercentualCustom() {
      const radios = document.querySelectorAll('input[name="percentualEntrega"]');
      const customContainer = document.getElementById('percentualCustomContainer');
      let outroSelecionado = false;
      
      radios.forEach(radio => {
        if (radio.checked && radio.value === 'outro') {
          outroSelecionado = true;
        }
        if (radio.value !== 'outro') {
          radio.onchange = () => {
            customContainer.style.display = 'none';
          };
        }
      });
      
      customContainer.style.display = outroSelecionado ? 'block' : 'none';
    }

    // função de leitura do radio/checkbox de intercaladas
    function lerParcelasIntercaladas() {
      const usarZero = document.getElementById('usarIntercaladasZero').checked;
      if (usarZero) return 0;
      const r = document.querySelector('input[name="parcelasIntercaladas"]:checked');
      if (!r) return 4; // fallback
      return parseInt(r.value, 10) || 4;
    }

    // função de leitura do percentual até entrega (radios)
    function lerPercentualEntrega() {
      const r = document.querySelector('input[name="percentualEntrega"]:checked');
      
      if (r && r.value === 'outro') {
        const customValue = parseFloat(document.getElementById('percentualCustom').value);
        if (!customValue || customValue < 1 || customValue > 100) {
          alert('Por favor, informe um percentual válido entre 1 e 100.');
          return null;
        }
        return customValue / 100;
      }
      
      return parseFloat(r?.value || '60') / 100;
    }

    function compartilharWhatsApp() {
      const texto = document.getElementById('resultado').innerText;
      if (!texto.trim()) { alert('Calcule primeiro para compartilhar.'); return; }
      const msg = encodeURIComponent(`Simulação de fluxo de pagamento:\n\n${texto}`);
      const url = `https://wa.me/?text=${msg}`;

      try {
        const opened = window.open(url, '_blank');
        if (!opened) window.location.href = url;
      } catch (e) {
        window.location.href = url;
      }
    }

    document.getElementById('btnCalcular').addEventListener('click', calcularFluxo);
    document.getElementById('btnWhatsapp').addEventListener('click', compartilharWhatsApp);

    function calcularFluxo() {
      // Ler inputs com proteções para null
      const valorTotal = obterValorNumerico((document.getElementById('valor') || {}).value || '0,00');
      const percentualEntrega = lerPercentualEntrega();
      
      // Se percentualEntrega retornou null (validação falhou), interrompe
      if (percentualEntrega === null) {
        return;
      }
      
      const percentualSinal = (parseFloat((document.getElementById('percentualSinal') || {}).value) || 10) / 100;
      const parcelasMensais = parseInt((document.getElementById('parcelasMensais') || {}).value,10) || 0;
      const parcelasIntercaladas = lerParcelasIntercaladas();
      const parcelasSinal = parseInt((document.getElementById('parcelasSinal') || {}).value,10) || 1;

      // Validações
      const out = document.getElementById('resultado');
      out.innerHTML = '';
      if (isNaN(valorTotal) || valorTotal <= 0) { out.innerHTML = `<strong style='color:red'>Erro:</strong> Valor do imóvel inválido.`; return; }
      if (percentualSinal > percentualEntrega) { out.innerHTML = `<strong style='color:red'>Erro:</strong> O percentual do sinal não pode ser maior que o percentual até a entrega.`; return; }
      if (parcelasMensais === 0 && parcelasIntercaladas === 0) { out.innerHTML = `<strong style='color:red'>Erro:</strong> Pelo menos um dos campos de parcelas (mensais ou intercaladas) deve ser maior que zero.`; return; }

      // Cálculos
      const totalAteEntrega = valorTotal * percentualEntrega; // ex: 60% do imóvel
      const valorSinal = valorTotal * percentualSinal; // ex: 10% do imóvel
      const percentualRestante = percentualEntrega - percentualSinal; // o que falta até o percentualEntrega

      // dividir o percentual restante entre mensais e intercaladas (metade/metade por padrão)
      let percentualMensais = percentualRestante / 2;
      let percentualIntercaladas = percentualRestante / 2;

      // se intercaladas for zero, repassa tudo para mensais
      if (parcelasIntercaladas === 0) {
        percentualMensais = percentualRestante;
        percentualIntercaladas = 0;
      }

      // calcular valores unitários e totais
      const valorTotalMensaisParte = valorTotal * percentualMensais; // total em reais destinado às mensais
      const valorTotalIntercaladasParte = valorTotal * percentualIntercaladas; // total em reais destinado às intercaladas

      const valorMensais = parcelasMensais > 0 ? (valorTotalMensaisParte / parcelasMensais) : 0;
      const valorIntercaladas = parcelasIntercaladas > 0 ? (valorTotalIntercaladasParte / parcelasIntercaladas) : 0;

      const saldoEntrega = valorTotal - totalAteEntrega;

      const fmt = v => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

      // Soma de conferência (sinal + total das mensais + total das intercaladas)
      const somaPartes = valorSinal + (valorMensais * parcelasMensais) + (valorIntercaladas * parcelasIntercaladas);

      // Exibir resultado claro para cliente
      out.innerHTML = `
        <strong>Valor do imóvel:</strong> ${fmt(valorTotal)}<br>
        <strong>Valor do sinal (${(percentualSinal*100).toFixed(2).replace('.00','')}%):</strong> ${fmt(valorSinal)} (${parcelasSinal}x de ${fmt(valorSinal / parcelasSinal)})<br>
        <strong>Total até a entrega (${(percentualEntrega*100).toFixed(2).replace('.00','')}%):</strong> ${fmt(totalAteEntrega)}<br>

        <hr>
        <strong>Parcelas mensais (${parcelasMensais}x):</strong> ${fmt(valorMensais)} ${parcelasIntercaladas === 0 ? '<span class="small">(inclui porcentagem das intercaladas)</span>' : ''}<br>
        <em class="small">Parte original das mensais:</em> ${fmt(valorTotalMensaisParte)}<br>
        ${parcelasIntercaladas === 0 ? `<em class="small">Parte absorvida das intercaladas:</em> ${fmt(valorTotalIntercaladasParte)}<br>` : ''}
        <em class="small">Total das mensais (valor unitário × nº parcelas):</em> ${fmt(valorMensais * parcelasMensais)}<br>

        <strong>Intercaladas (${parcelasIntercaladas}x):</strong> ${fmt(valorIntercaladas)}<br>
        <em class="small">Total das intercaladas:</em> ${fmt(valorIntercaladas * parcelasIntercaladas)}<br>

        <strong>Saldo na entrega (${((1 - percentualEntrega)*100).toFixed(2).replace('.00','')}%):</strong> ${fmt(saldoEntrega)}<br>

        <br>
        <strong>✅ Conferência (soma das partes até a entrega):</strong><br>
        Sinal: ${fmt(valorSinal)} + Mensais (total): ${fmt(valorMensais * parcelasMensais)} + Intercaladas (total): ${fmt(valorIntercaladas * parcelasIntercaladas)} = <strong>${fmt(somaPartes)}</strong><br>
        <em class="small">Deve ser igual a Total até a entrega: ${fmt(totalAteEntrega)}</em>
      `;
    }
  </script>
</body>
</html>
